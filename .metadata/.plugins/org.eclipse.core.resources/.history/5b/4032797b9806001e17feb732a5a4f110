package com.paymentgateway.phonepe;

import java.nio.charset.StandardCharsets;
import java.util.Base64;



public class TestNewPayment {

//	const crypto = require('crypto');
//	const request = require('request');


	String PHONEPE_SALTKEY = "537735a0-d4f2-4761-af5b-887320cb73ab";
	String PHONEPE_MID = "POKERDADDYUAT";
	String SERVER_URL = "https://pokerapi.pokerdaddy.in";
	String PHONEPE_CALLBACK_URL = SERVER_URL + "/pokerApi/v1/purchase/payments/phonepe/return";
	String PURCHASE_REDIRECT_URL = SERVER_URL + "/ngaccount/web/add-money/payment-complete/";
	String PHONEPE_REQUEST_URL = "https://api-preprod.phonepe.com/apis/merchant-simulator/pg/v1/pay";
	
	static TestNewPayment tnp=new TestNewPayment() ;
	
	public static void main(String args[]) {
		try {
			//TestNewPayment tnp=new TestNewPayment() ;
			tnp.paymentPhonpe();
		}catch(Exception e) {
			e.printStackTrace();
		}
	}
	public boolean paymentPhonpe() {
		String purchaseId = "1006";
		String userId = "629388";
		int txnAmount = 116;
		txnAmount = txnAmount*100;


		

		try {
			
			String phonepe_payload_card_initiate = "{"+
				    "\"merchantId\":\"" +PHONEPE_MID+"\","+
				    "\"merchantTransactionId\":"+ purchaseId+","+
				    "\"merchantUserId\":\""+ userId+"\","+
				    "\"amount\":"+ txnAmount+","+
				    "\"redirectUrl\":\""+ PURCHASE_REDIRECT_URL + purchaseId+"\","+
				    "\"redirectMode\": \"POST\","+
				    "\"callbackUrl\":\""+ PHONEPE_CALLBACK_URL+"\","+
				    "\"paymentInstrument\": {"+
				    "\"type\":\"PAY_PAGE\""+
				    "}"+
				"}";
			
			
			
			//String text = "Best Credit Card for Student is something which give maximum rebate to Student" + "when they purchase books, courses and other stationary items"; 
			String mimeEndoded = Base64.getMimeEncoder() .encodeToString(phonepe_payload_card_initiate.getBytes(StandardCharsets.UTF_8)); 
			System.out.println("original string: " + phonepe_payload_card_initiate); 
			System.out.println("base65 encoded using MIME encoder: "); 
			System.out.println(mimeEndoded);

		String checksum = mimeEndoded + "/pg/v1/pay" + 1;
			
		System.out.println("checksum===="+checksum);
		
		//String hash = crypto.createHash("sha256").update(checksum, "utf-8").digest("hex");
		
		String hash = tnp.bytesToHex(checksum.getBytes());
		System.out.println("hash===="+hash);
		
		
		String phonepe_request = "{"+
			    "\"method\": \"POST\","+
			    "\"url\":\""+ PHONEPE_REQUEST_URL+"\","+
			    "\"headers\": {"+
			     "\"Content-Type\": \"application/json\","+
			        "\"X-VERIFY\":\""+ hash.trim() + "###1\""+
			    "},"+
			    "\"body\": {"+ 
			       "\"request\":\""+ mimeEndoded.trim()+"\""+
			    "} "+
			"}";
		
		System.out.println("phonepe_request===="+phonepe_request);
		
		
		}catch(Exception e) {
			e.printStackTrace();
		}
		return true;
	}
	private static String bytesToHex(byte[] hash) {
	    StringBuilder hexString = new StringBuilder(2 * hash.length);
	    for (int i = 0; i < hash.length; i++) {
	        String hex = Integer.toHexString(0xff & hash[i]);
	        if(hex.length() == 1) {
	            hexString.append('0');
	        }
	        hexString.append(hex);
	    }
	    return hexString.toString();
	}
}
