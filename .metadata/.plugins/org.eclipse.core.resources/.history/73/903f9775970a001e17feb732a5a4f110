package com.paymentgateway.phonePe;

import java.io.IOException;
import java.util.Base64;
import java.util.HashMap;

import com.google.gson.Gson;

import okhttp3.MediaType;
import okhttp3.Request;
import okhttp3.RequestBody;

public class testPhonpe {

	public static void main(String[] args) {
		// TODO Auto-generated method stub
		try {
			
		}catch(Exception e) {
			e.printStackTrace();
		}
	}
	public String initiatePhonepePayment(String purchaseId, String userId, int txnAmount) throws IOException {
		//Properties prop = common.getAllProperties();
		
//		String purchaseId = "1006";
//		String userId = "629388";
//		int txnAmount = 116;
		txnAmount = txnAmount*100;
		String responseStr="";
		
		/*
		 * String baseUrl = prop.getProperty("PHONEPE_BASE_URL"); String payEndpoint =
		 * prop.getProperty("PHONEPE_PAY_ENDPOINT"); String PHONEPE_MID =
		 * prop.getProperty("PHONEPE_MID"); String PURCHASE_REDIRECT_URL =
		 * prop.getProperty("PURCHASE_REDIRECT_URL"); String PHONEPE_CALLBACK_URL =
		 * prop.getProperty("PHONEPE_CALLBACK_URL"); saltKey =
		 * prop.getProperty("PHONEPE_SALTKEY"); saltIndex =
		 * prop.getProperty("PHONEPE_SALT_INDEX"); PHONEPE_REQUEST_URL = baseUrl +
		 * payEndpoint;
		 */
		HashMap prop = common.readProperty("phonePe.properties");
		
		//phonepeResponse phonepeResponseData=new phonepeResponse();
		//txnAmount = txnAmount*100;
		
		String baseUrl = prop.get("PHONEPE_BASE_URL").toString();
		String payEndpoint = prop.get("PHONEPE_PAY_ENDPOINT").toString();
		String PHONEPE_MID = prop.get("PHONEPE_MID").toString();
		String PURCHASE_REDIRECT_URL = prop.get("PURCHASE_REDIRECT_URL").toString();
		String PHONEPE_CALLBACK_URL = prop.get("PHONEPE_CALLBACK_URL").toString();
		saltKey = prop.get("PHONEPE_SALTKEY").toString();
		saltIndex = prop.get("PHONEPE_SALT_INDEX").toString();
		PHONEPE_REQUEST_URL = baseUrl + payEndpoint;
		
		try {
			
			/*
			 * String phonepe_payload_card_initiate
			 * =ppRequestGenerator.requestCreator("NETBANKING","1234","MU933037302229373",
			 * 100000,"9717323931","SBIN","4208585190116667",
			 * "10","Arvind Chaturvedi","06","2027","508","c116-sector 22",
			 * "noida","noida","U.P.","302021","india","C903889349294273423","1234",
			 * "1234","1234","1234");
			 */
			
			
			  String phonepe_payload_card_initiate = "{"+
			  "\"merchantId\":\""+PHONEPE_MID+"\","+ "\"merchantTransactionId\":\""+
			  purchaseId+"\","+ "\"merchantUserId\":\""+userId+"\","+ "\"amount\":\""+
			  txnAmount+"\","+ "\"redirectUrl\":\""+ PURCHASE_REDIRECT_URL +
			  purchaseId+"\","+ "\"redirectMode\":\"POST\","+ "\"callbackUrl\":\""+
			  PHONEPE_CALLBACK_URL+"\","+ "\"paymentInstrument\":{"+
			  "\"type\":\"PAY_PAGE\""+ "}}";
			 
			
			//phonepe_payload_card_initiate = JSON.stringify(phonepe_payload_card_initiate);

			
			System.out.println("PHONEPE-INITIATE-REQUEST"+ "raw_payload=====     "+ phonepe_payload_card_initiate);
			        
			//String encoded = Buffer.from(phonepe_payload_card_initiate, "utf8").toString("base64");
			String encoded =Base64.getEncoder().encodeToString(phonepe_payload_card_initiate.getBytes());

			//console.log('');
			System.out.println("PHONEPE-INITIATE-REQUEST"+ "encoded=====      "+ encoded);
			


			String checksum = encoded + "/pg/v1/pay" +saltKey;

			
			System.out.println("PHONEPE-INITIATE-REQUEST"+ "checksum====    "+ checksum);

			//String hash = crypto.createHash("sha256").update(checksum, "utf-8").digest("hex");
			String hash =HashCrypto(checksum);
			
			System.out.println("PHONEPE-INITIATE-REQUEST"+ "hash----    "+ hash);

//			String phonepe_request = "{"+
//				    "\"method\": \"POST\","+
//				    "\"url\":\""+ PHONEPE_REQUEST_URL+"\","+
//				    "\"headers\": {"+
//						"\"Content-Type\": \"application/json\","+
//						"\"X-VERIFY\":\""+ hash + "###" + saltIndex + "\""+
//				    "},"+
//				    "\"body\":{"+ 
//				        "\"request\":\""+ encoded+"\""+
//				    "}"+
//				"}";
			
			System.out.println("encoded----    "+encoded);
			
			MediaType mediaType = MediaType.parse("application/json");
    		RequestBody body = RequestBody.create(mediaType, "{\"request\":\""+encoded+"\"}");
    		Request request = new Request.Builder()
    		  .url(PHONEPE_REQUEST_URL)
    		  .post(body)
    		  .addHeader("accept", "application/json")
    		  .addHeader("Content-Type", "application/json")
    		  .addHeader("X-VERIFY", hash + "###" + saltIndex)
    		  .build();
			okhttp3.Response response = client.newCall(request).execute();
			
			System.out.println("Response body---     "+response.body());
			System.out.println("Response body---     "+response.message());
			System.out.println("Response body---     "+response.code());
			System.out.println("Response body---     "+response.toString());
			
			responseStr=response.body().string();
//			{"success":true,"code":"PAYMENT_INITIATED","message":"Payment initiated",
//			"data":{"merchantId":"GAMEZDADDYUAT","merchantTransactionId":"1006",
//			"transactionId":"T2306071554587550922237",
//			"instrumentResponse":{"type":"PAY_PAGE",
//			"redirectInfo":{"url":"https://mercury-uat.phonepe.com/transact/simulator?token=EsK1KHMD5RibgTPNRCk0KzXyGiFbmuGQp52GVhROqBV"
//			,"method":"GET"}}}}
//		
//		  ObjectMapper objectMapper = new ObjectMapper();
//		  ResponseBean bean = objectMapper.readValue(response.body().string(), ResponseBean.class);
		
			Gson gson = new Gson();
			ResponseBean bean = gson.fromJson(response.body().string(), ResponseBean.class);
	        
			
			System.out.println("bean::::::::::::::::::::     "+bean);
			System.out.println("bean::::::::::::::::::::     "+ bean.getCode());
			System.out.println("bean::::::::::::::::::::     "+ bean.getMessage());
			System.out.println("bean::::::::::::::::::::     "+ bean.getSuccess());
			System.out.println("bean::::::::::::::::::::     "+ bean.getData());
			System.out.println("bean::::::::::::::::::::     "+ bean.getData().getMerchantId());
			System.out.println("bean::::::::::::::::::::     "+ bean.getData().getMerchantTransactionId());
			System.out.println("bean::::::::::::::::::::     "+ bean.getData().getTransactionId());
			System.out.println("bean::::::::::::::::::::     "+ bean.getData().getInstrumentResponse().getType());
			System.out.println("bean::::::::::::::::::::     "+ bean.getData().getInstrumentResponse().getRedirectInfo().getMethod());
			System.out.println("bean::::::::::::::::::::     "+ bean.getData().getInstrumentResponse().getRedirectInfo().getUrl());
		
//			savePhonePeRequest(bean);
			return responseStr;
			
		}catch(Exception e) {
			e.printStackTrace();
		}
		return responseStr;
	}
}
